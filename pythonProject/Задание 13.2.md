# Домашнее задание к занятию "13.2 разделы и монтирование"
Приложение запущено и работает, но время от времени появляется необходимость передавать между бекендами данные. А сам бекенд генерирует статику для фронта. Нужно оптимизировать это.
Для настройки NFS сервера можно воспользоваться следующей инструкцией (производить под пользователем на сервере, у которого есть доступ до kubectl):
* установить helm: curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
* добавить репозиторий чартов: helm repo add stable https://charts.helm.sh/stable && helm repo update
* установить nfs-server через helm: helm install nfs-server stable/nfs-server-provisioner
```
www@www:~$ sudo kubectl get pod -o wide -A
NAMESPACE       NAME                                      READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
default         nfs-server-nfs-server-provisioner-0       1/1     Running   0          5d4h    10.233.75.4      node2   <none>           <none>
ingress-nginx   ingress-nginx-controller-cgqwd            1/1     Running   0          5d5h    10.233.75.1      node2   <none>           <none>
kube-system     calico-kube-controllers-d6484b75c-ptkc4   1/1     Running   0          5d5h    10.233.75.2      node2   <none>           <none>
kube-system     calico-node-4hcz9                         1/1     Running   0          5d5h    10.130.0.32      node1   <none>           <none>
kube-system     calico-node-kx9jq                         1/1     Running   0          5d5h    10.130.0.7       node2   <none>           <none>
kube-system     coredns-588bb58b94-799bk                  1/1     Running   0          5d5h    10.233.102.129   node1   <none>           <none>
kube-system     coredns-588bb58b94-mwzk8                  1/1     Running   0          5d5h    10.233.75.3      node2   <none>           <none>
kube-system     dns-autoscaler-5b9959d7fc-mrtzl           1/1     Running   0          5d5h    10.233.102.130   node1   <none>           <none>
kube-system     kube-apiserver-node1                      1/1     Running   1          5d5h    10.130.0.32      node1   <none>           <none>
kube-system     kube-controller-manager-node1             1/1     Running   1          5d5h    10.130.0.32      node1   <none>           <none>
kube-system     kube-proxy-4v9dk                          1/1     Running   0          5d5h    10.130.0.32      node1   <none>           <none>
kube-system     kube-proxy-l7c2v                          1/1     Running   0          5d5h    10.130.0.7       node2   <none>           <none>
kube-system     kube-scheduler-node1                      1/1     Running   1          5d5h    10.130.0.32      node1   <none>           <none>
kube-system     metrics-server-5c9dd56466-kpwqj           1/1     Running   0          5d5h    10.233.102.131   node1   <none>           <none>
kube-system     nginx-proxy-node2                         1/1     Running   0          5d5h    10.130.0.7       node2   <none>           <none>
kube-system     nodelocaldns-c7vkz                        1/1     Running   0          5d5h    10.130.0.32      node1   <none>           <none>
kube-system     nodelocaldns-vxb4x                        1/1     Running   0          5d5h    10.130.0.7       node2   <none>           <none>
production      backend-7958f69d9c-jfl6g                  1/1     Running   0          2m58s   10.233.75.27     node2   <none>           <none>
production      database-8464dd4766-744bj                 1/1     Running   0          10m     10.233.75.26     node2   <none>           <none>
production      frontend-7d6957cf45-mrsjh                 1/1     Running   0          29s     10.233.75.28     node2   <none>           <none>
stage           backend-56858886-gvpqw                    1/1     Running   0          75m     10.233.75.21     node2   <none>           <none>
stage           frontend-7d996c486d-gh6bd                 1/1     Running   0          74m     10.233.75.22     node2   <none>           <none>
stage           postgres-0                                1/1     Running   0          75m     10.233.75.20     node2   <none>           <none>
```
В конце установки будет выдан пример создания PVC для этого сервера.

## Задание 1: подключить для тестового конфига общую папку
В stage окружении часто возникает необходимость отдавать статику бекенда сразу фронтом. Проще всего сделать это через общую папку. Требования:
* в поде подключена общая папка между контейнерами (например, /static);
* после записи чего-либо в контейнере с беком файлы можно получить из контейнера с фронтом.
```
www@www:~$ sudo kubectl get -n stage pods
NAME                        READY   STATUS    RESTARTS   AGE
backend-56858886-gvpqw      1/1     Running   0          91m
frontend-7d996c486d-gh6bd   1/1     Running   0          90m
pod-int-volumes             2/2     Running   0          39s
postgres-0                  1/1     Running   0          91m
www@www:~$ sudo kubectl -n stage exec pod-int-volumes -c nginx -- sh -c "echo 'test' > /static/test.txt"
www@www:~$ sudo kubectl -n stage exec pod-int-volumes -c nginx -- ls -la /static
total 12
drwxrwxrwx 2 root root 4096 Dec 16 19:30 .
drwxr-xr-x 1 root root 4096 Dec 16 19:26 ..
-rw-r--r-- 1 root root    5 Dec 16 19:30 test.txt
www@www:~$ sudo kubectl -n stage exec pod-int-volumes -c nginx -- cat /static/test.txt
test
www@www:~$ sudo kubectl -n stage exec pod-int-volumes -c busybox -- ls -la /tmp/cache
total 12
drwxrwxrwx    2 root     root          4096 Dec 16 19:30 .
drwxrwxrwt    1 root     root          4096 Dec 16 19:26 ..
-rw-r--r--    1 root     root             5 Dec 16 19:30 test.txt
www@www:~$ sudo kubectl -n stage exec pod-int-volumes -c busybox -- cat /tmp/cache/test.txt
www@www:~$ sudo kubectl -n stage exec pod-int-volumes -c busybox -- touch /tmp/cache/test2.txt
www@www:~$ sudo kubectl -n stage exec pod-int-volumes -c nginx -- ls -la /static
total 12
drwxrwxrwx 2 root root 4096 Dec 16 19:32 .
drwxr-xr-x 1 root root 4096 Dec 16 19:26 ..
-rw-r--r-- 1 root root    5 Dec 16 19:30 test.txt
-rw-r--r-- 1 root root    0 Dec 16 19:32 test2.txt
```

## Задание 2: подключить общую папку для прода
Поработав на stage, доработки нужно отправить на прод. В продуктиве у нас контейнеры крутятся в разных подах, поэтому потребуется PV и связь через PVC. Сам PV должен быть связан с NFS сервером. Требования:
* все бекенды подключаются к одному PV в режиме ReadWriteMany;
* фронтенды тоже подключаются к этому же PV с таким же режимом;
* файлы, созданные бекендом, должны быть доступны фронту.


```
www@www:~$ sudo kubectl get sc
NAME   PROVISIONER                                       RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
nfs    cluster.local/nfs-server-nfs-server-provisioner   Delete          Immediate           true                   5d4h
www@www:~$ sudo kubectl get csinodes
NAME    DRIVERS   AGE
node1   0         5d6h
node2   0         5d6h 
www@www:~$ sudo kubectl get po,pvc,pv
NAME                            READY   STATUS    RESTARTS   AGE
pod/backend-7958f69d9c-jfl6g    1/1     Running   0          21h
pod/database-8464dd4766-744bj   1/1     Running   0          22h
pod/frontend-7d6957cf45-9sblh   1/1     Running   0          22h

NAME                                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/backend-disk        Bound    pvc-d53b7a43-ec75-4e24-8f33-c9d314ef6594   100Mi      RWO            nfs            21h
persistentvolumeclaim/frontend-disk       Bound    pvc-df27d91f-cf75-425c-a96b-d3dd86792eff   100Mi      RWO            nfs            22h
persistentvolumeclaim/postgres-db-disks   Bound    pvc-ff6b4d3a-03d9-4bba-a1c8-c96560c7998b   100Mi      RWO            nfs            22h

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                          STORAGECLASS   REASON   AGE
persistentvolume/pvc-2b42978d-4731-4473-b6ee-40ee82e095ca   100Mi      RWO            Delete           Bound    stage/backend-disk             nfs                     23h
persistentvolume/pvc-3d0ac96b-8ade-46b7-b209-a6aefafea777   100Mi      RWO            Delete           Bound    stage/postgres-db-disks        nfs                     23h
persistentvolume/pvc-d53b7a43-ec75-4e24-8f33-c9d314ef6594   100Mi      RWO            Delete           Bound    production/backend-disk        nfs                     21h
persistentvolume/pvc-df27d91f-cf75-425c-a96b-d3dd86792eff   100Mi      RWO            Delete           Bound    production/frontend-disk       nfs                     22h
persistentvolume/pvc-ff6b4d3a-03d9-4bba-a1c8-c96560c7998b   100Mi      RWO            Delete           Bound    production/postgres-db-disks   nfs                     22h
```
---
манифесты: ` https://github.com/webdotwork/devops-net/tree/master/pythonProject/manifests `
### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
