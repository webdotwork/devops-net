# Домашнее задание к занятию "12.5 Сетевые решения CNI"
После работы с Flannel появилась необходимость обеспечить безопасность для приложения. Для этого лучше всего подойдет Calico.
## Задание 1: установить в кластер CNI плагин Calico
Для проверки других сетевых решений стоит поставить отличный от Flannel плагин — например, Calico. Требования: 
* установка производится через ansible/kubespray;
```
www@www:~$ sudo kubectl get pods -o wide -A
NAMESPACE       NAME                                      READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES
ingress-nginx   ingress-nginx-controller-4f7bc            1/1     Running   0          8h      10.233.71.1      node3   <none>           <none>
ingress-nginx   ingress-nginx-controller-4stnx            1/1     Running   0          8h      10.233.75.1      node2   <none>           <none>
ingress-nginx   ingress-nginx-controller-772rh            1/1     Running   0          8h      10.233.74.66     node4   <none>           <none>
ingress-nginx   ingress-nginx-controller-cxg8v            1/1     Running   0          8h      10.233.97.129    node5   <none>           <none>
kube-system     calico-kube-controllers-d6484b75c-dvrwt   1/1     Running   0          8h      10.233.74.65     node4   <none>           <none>
kube-system     calico-node-78jv5                         1/1     Running   0          8h      10.130.0.16      node4   <none>           <none>
kube-system     calico-node-dzwk5                         1/1     Running   0          8h      10.130.0.23      node1   <none>           <none>
kube-system     calico-node-j7s7v                         1/1     Running   0          8h      10.130.0.36      node3   <none>           <none>
kube-system     calico-node-pn96p                         1/1     Running   0          8h      10.130.0.18      node2   <none>           <none>
kube-system     calico-node-zhjbj                         1/1     Running   0          8h      10.130.0.38      node5   <none>           <none>
kube-system     coredns-588bb58b94-fzfnr                  1/1     Running   0          8h      10.233.71.2      node3   <none>           <none>
kube-system     coredns-588bb58b94-sdhjg                  1/1     Running   0          8h      10.233.102.129   node1   <none>           <none>
kube-system     dns-autoscaler-5b9959d7fc-st26m           1/1     Running   0          8h      10.233.102.130   node1   <none>           <none>
kube-system     kube-apiserver-node1                      1/1     Running   1          8h      10.130.0.23      node1   <none>           <none>
kube-system     kube-controller-manager-node1             1/1     Running   1          8h      10.130.0.23      node1   <none>           <none>
kube-system     kube-proxy-2f7cn                          1/1     Running   0          5h53m   10.130.0.18      node2   <none>           <none>
kube-system     kube-proxy-2krld                          1/1     Running   0          5h53m   10.130.0.16      node4   <none>           <none>
kube-system     kube-proxy-ks7bm                          1/1     Running   0          5h53m   10.130.0.23      node1   <none>           <none>
kube-system     kube-proxy-p8kfl                          1/1     Running   0          5h53m   10.130.0.38      node5   <none>           <none>
kube-system     kube-proxy-tltxj                          1/1     Running   0          5h53m   10.130.0.36      node3   <none>           <none>
kube-system     kube-scheduler-node1                      1/1     Running   1          8h      10.130.0.23      node1   <none>           <none>
kube-system     metrics-server-5c9dd56466-jb5j7           1/1     Running   0          8h      10.233.102.131   node1   <none>           <none>
kube-system     nginx-proxy-node2                         1/1     Running   0          8h      10.130.0.18      node2   <none>           <none>
kube-system     nginx-proxy-node3                         1/1     Running   0          8h      10.130.0.36      node3   <none>           <none>
kube-system     nginx-proxy-node4                         1/1     Running   0          8h      10.130.0.16      node4   <none>           <none>
kube-system     nginx-proxy-node5                         1/1     Running   0          8h      10.130.0.38      node5   <none>           <none>
kube-system     nodelocaldns-4wdjg                        1/1     Running   0          8h      10.130.0.36      node3   <none>           <none>
kube-system     nodelocaldns-9fx8b                        1/1     Running   0          8h      10.130.0.16      node4   <none>           <none>
kube-system     nodelocaldns-cqmv5                        1/1     Running   0          8h      10.130.0.18      node2   <none>           <none>
kube-system     nodelocaldns-k9qkt                        1/1     Running   0          8h      10.130.0.23      node1   <none>           <none>
kube-system     nodelocaldns-njm5w                        1/1     Running   0          8h      10.130.0.38      node5   <none>           <none>
```  
* после применения следует настроить политику доступа к hello-world извне. Инструкции [kubernetes.io](https://kubernetes.io/docs/concepts/services-networking/network-policies/), [Calico](https://docs.projectcalico.org/about/about-network-policy)
```
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl get pods
NAME                        READY   STATUS    RESTARTS   AGE
backend-7565d57698-2pmp5    1/1     Running   0          56s
cache-7d8f7d7c48-flvm8      1/1     Running   0          49s
frontend-7c55448646-qg9s4   1/1     Running   0          66s
```
```
www@www:~$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 frontend
Praqma Network MultiTool (with NGINX) - frontend-7c55448646-qg9s4 - 10.233.75.3
www@www:~$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 cache
Praqma Network MultiTool (with NGINX) - cache-7d8f7d7c48-flvm8 - 10.233.74.68
www@www:~$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 backend
Praqma Network MultiTool (with NGINX) - backend-7565d57698-2pmp5 - 10.233.97.131
```
```
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl apply -f ./16-networking/20-network-policy/manifests/network-policy/00-default.yaml
networkpolicy.networking.k8s.io/default-deny-ingress created
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl get networkpolicies
NAME                   POD-SELECTOR   AGE
default-deny-ingress   <none>         3m40s
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 frontend
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 cache
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 backend
command terminated with exit code 28
```
```
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl apply -f ./16-networking/20-network-policy/manifests/network-policy
networkpolicy.networking.k8s.io/default-deny-ingress unchanged
networkpolicy.networking.k8s.io/frontend created
networkpolicy.networking.k8s.io/backend created
networkpolicy.networking.k8s.io/cache created
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 frontend
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 cache
Praqma Network MultiTool (with NGINX) - cache-7d8f7d7c48-flvm8 - 10.233.74.68
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec backend-7565d57698-2pmp5 -- curl -s -m 1 backend
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec frontend-7c55448646-qg9s4 -- curl -s -m 1 frontend
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec frontend-7c55448646-qg9s4 -- curl -s -m 1 backend
Praqma Network MultiTool (with NGINX) - backend-7565d57698-2pmp5 - 10.233.97.131
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec frontend-7c55448646-qg9s4 -- curl -s -m 1 cache
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec cache-7d8f7d7c48-flvm8 -- curl -s -m 1 cache
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec cache-7d8f7d7c48-flvm8 -- curl -s -m 1 frontend
command terminated with exit code 28
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl exec cache-7d8f7d7c48-flvm8 -- curl -s -m 1 backend
command terminated with exit code 28
```
```
www@www:~/Desktop/CI/kb/kubernetes-for-beginners$ sudo kubectl get networkpolicies
NAME                   POD-SELECTOR   AGE
backend                app=backend    4m7s
cache                  app=cache      4m7s
default-deny-ingress   <none>         13m
frontend               app=frontend   4m7s
```
## Задание 2: изучить, что запущено по умолчанию
Самый простой способ — проверить командой calicoctl get <type>. Для проверки стоит получить список нод, ipPool и profile.
Требования: 
* установить утилиту calicoctl;
```
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.24.5/manifests/calicoctl-etcd.yaml
```
* получить 3 вышеописанных типа в консоли.
```
yc-user@node1:~$ calicoctl get nodes
NAME
node1
node2
node3
node4
node5
```
```
yc-user@node1:~$ calicoctl get ipPool
NAME           CIDR             SELECTOR
default-pool   10.233.64.0/18   all()
```
```
yc-user@node1:~$ calicoctl get profile
NAME
projectcalico-default-allow
kns.default
kns.ingress-nginx
kns.kube-node-lease
kns.kube-public
kns.kube-system
ksa.default.default
ksa.ingress-nginx.default
ksa.ingress-nginx.ingress-nginx
ksa.kube-node-lease.default
ksa.kube-public.default
ksa.kube-system.attachdetach-controller
ksa.kube-system.bootstrap-signer
ksa.kube-system.calico-kube-controllers
ksa.kube-system.calico-node
ksa.kube-system.certificate-controller
ksa.kube-system.clusterrole-aggregation-controller
ksa.kube-system.coredns
ksa.kube-system.cronjob-controller
ksa.kube-system.daemon-set-controller
ksa.kube-system.default
ksa.kube-system.deployment-controller
ksa.kube-system.disruption-controller
ksa.kube-system.dns-autoscaler
ksa.kube-system.endpoint-controller
ksa.kube-system.endpointslice-controller
ksa.kube-system.endpointslicemirroring-controller
ksa.kube-system.ephemeral-volume-controller
ksa.kube-system.expand-controller
ksa.kube-system.generic-garbage-collector
ksa.kube-system.horizontal-pod-autoscaler
ksa.kube-system.job-controller
ksa.kube-system.kube-proxy
ksa.kube-system.metrics-server
ksa.kube-system.namespace-controller
ksa.kube-system.node-controller
ksa.kube-system.nodelocaldns
ksa.kube-system.persistent-volume-binder
ksa.kube-system.pod-garbage-collector
ksa.kube-system.pv-protection-controller
ksa.kube-system.pvc-protection-controller
ksa.kube-system.replicaset-controller
ksa.kube-system.replication-controller
ksa.kube-system.resourcequota-controller
ksa.kube-system.root-ca-cert-publisher
ksa.kube-system.service-account-controller
ksa.kube-system.service-controller
ksa.kube-system.statefulset-controller
ksa.kube-system.token-cleaner
ksa.kube-system.ttl-after-finished-controller
ksa.kube-system.ttl-controller  
```

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
